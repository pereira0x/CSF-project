#!/usr/bin/python
import urllib.request
import urllib.parse
import http.client
import subprocess
import sys
import base64
import os
from Crypto.Cipher import AES
import hashlib
import time
import random
import string

password = "CZN.pjp0paz3jej5jgajcj!hzx3yzp2DTB1hgy"

def decrypt(enc, password):
    private_key = hashlib.sha256(password.encode("utf-8")).digest()
    enc = base64.b64decode(enc)
    iv = enc[:16]
    cipher = AES.new(private_key, AES.MODE_CFB, iv)
    return cipher.decrypt(enc[16:])

# URL decode
def urldecode(s):
    return urllib.parse.unquote(s)

def random_string(length):
    return ''.join(random.choice(string.ascii_letters) for m in range(length))


f = open("./msg", "r")

communications = []

DEBUG = True


# Save dir with timestamp
SAVE_DIR = "save_" + str(int(time.time()))

# Create dir
os.mkdir(SAVE_DIR)

filename = ""

# read file line by line
for line in f.readlines():
    line = line.strip()
    file = False
    # Convert to bytes
    if line.startswith("new") or line == "":
        continue
    # if line is empty, we have a new communication
    if line.startswith("cmd="):
        line = line[4:].strip()
        line = urldecode(line)
    elif line.startswith("file="):
        print("file")
        line = line[5:].strip()
        line = urldecode(line)
        file = True

    content = decrypt(line, password)


    if file:
        # Save file
        print("Saving file")
        filename = random_string(10)
        filepath = SAVE_DIR + "/" + filename
        print(filepath)
        f = open(filepath, "wb")
        f.write(content)
        f.close()
        filename = ""
    else:
        print(line)
        print(content)
        print("")
        if b'download' in content:
            filename = content.split(b"/")[-1].decode()
        communications.append(content)


# write communications to file
f = open(SAVE_DIR + "/output", "wb")
for comm in communications:
    f.write(comm + b"\n")
f.close()

print("Saved to " + SAVE_DIR)
